<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT ë³´ìƒì‘ìš© ìœ„í‚¤ - 5Why ê·¸ë˜í”„ ì‹œê°í™”</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #main-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            cursor: default;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #666;
            text-align: center;
        }

        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffebee;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            color: #c62828;
            text-align: center;
            padding: 40px;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
            max-width: 600px;
        }

        .retry-button {
            padding: 12px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-button:hover {
            background: #1976d2;
        }

        /* ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê²½ê³  */
        .compatibility-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 10000;
            display: none;
        }

        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .loading-text {
                font-size: 14px;
                padding: 0 20px;
            }

            .error-message {
                font-size: 14px;
            }
        }

        /* 1GB RAM ìµœì í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .performance-mode-low * {
            animation-duration: 0.5s !important;
            transition-duration: 0.2s !important;
        }

        .performance-mode-low .main-button {
            transition: none !important;
        }
    </style>
</head>
<body>
    <!-- ë©”ì¸ ìº”ë²„ìŠ¤ -->
    <canvas id="main-canvas"></canvas>

    <!-- ë¡œë”© í™”ë©´ -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            <div>ğŸ¥ PT ë³´ìƒì‘ìš© ìœ„í‚¤ ë¡œë”© ì¤‘...</div>
            <div style="font-size: 12px; margin-top: 10px; color: #999;">
                1GB RAM ìµœì í™” ëª¨ë“œë¡œ ì´ˆê¸°í™”í•˜ê³  ìˆìŠµë‹ˆë‹¤
            </div>
        </div>
    </div>

    <!-- ì˜¤ë¥˜ í™”ë©´ -->
    <div id="error-screen" class="error-screen">
        <div class="error-icon">âš ï¸</div>
        <div class="error-title">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨</div>
        <div class="error-message" id="error-message">
            ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
        </div>
        <button class="retry-button" onclick="location.reload()">
            ğŸ”„ ë‹¤ì‹œ ì‹œë„
        </button>
    </div>

    <!-- ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ê²½ê³  -->
    <div id="compatibility-warning" class="compatibility-warning">
        âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Chrome, Firefox, Safari ìµœì‹  ë²„ì „ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
        <button onclick="this.parentElement.style.display='none'" style="margin-left: 10px; background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 3px;">ë‹«ê¸°</button>
    </div>

    <!-- í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„° -->
    <script id="dummy-graph-data" type="application/json">
    {
        "nodes": [
            {
                "id": "calf-pain",
                "label": "ì¢…ì•„ë¦¬ í†µì¦",
                "type": "symptom",
                "x": 0,
                "y": 0,
                "size": 30,
                "importance": 1.0
            },
            {
                "id": "gastrocnemius-tightness",
                "label": "ë¹„ë³µê·¼ ê¸´ì¥",
                "type": "cause",
                "x": 150,
                "y": -50,
                "size": 25,
                "importance": 0.8
            },
            {
                "id": "achilles-shortening",
                "label": "ì•„í‚¬ë ˆìŠ¤ê±´ ë‹¨ì¶•",
                "type": "cause",
                "x": 300,
                "y": -100,
                "size": 25,
                "importance": 0.7
            },
            {
                "id": "ankle-dorsiflexion-limitation",
                "label": "ë°œëª© ë°°ì¸¡êµ´ê³¡ ì œí•œ",
                "type": "cause",
                "x": 450,
                "y": -150,
                "size": 25,
                "importance": 0.6
            },
            {
                "id": "prolonged-sitting",
                "label": "ì¥ì‹œê°„ ì•‰ê¸°",
                "type": "cause",
                "x": 600,
                "y": -200,
                "size": 20,
                "importance": 0.5
            }
        ],
        "edges": [
            {
                "id": "edge-1",
                "source": "gastrocnemius-tightness",
                "target": "calf-pain",
                "type": "causes",
                "weight": 0.8,
                "label": "ê·¼ìœ¡ ê¸´ì¥ì´ í†µì¦ì„ ìœ ë°œí•¨"
            },
            {
                "id": "edge-2",
                "source": "achilles-shortening",
                "target": "gastrocnemius-tightness",
                "type": "causes",
                "weight": 0.75,
                "label": "ì•„í‚¬ë ˆìŠ¤ê±´ ë‹¨ì¶•ì´ ë¹„ë³µê·¼ ê¸´ì¥ì„ ìœ ë°œí•¨"
            },
            {
                "id": "edge-3",
                "source": "ankle-dorsiflexion-limitation",
                "target": "achilles-shortening",
                "type": "causes",
                "weight": 0.7,
                "label": "ë°œëª© ê°€ë™ì„± ì œí•œì´ ì•„í‚¬ë ˆìŠ¤ê±´ ë‹¨ì¶•ì„ ìœ ë°œí•¨"
            },
            {
                "id": "edge-4",
                "source": "prolonged-sitting",
                "target": "ankle-dorsiflexion-limitation",
                "type": "causes",
                "weight": 0.6,
                "label": "ì¥ì‹œê°„ ì•‰ê¸°ê°€ ë°œëª© ê°€ë™ì„±ì„ ì œí•œí•¨"
            }
        ]
    }
    </script>

    <!-- ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import PTCompensationWiki from './js/main-app.js';

        // ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
        function checkBrowserCompatibility() {
            const checks = {
                canvas: !!document.createElement('canvas').getContext,
                indexedDB: !!window.indexedDB,
                webGL: !!document.createElement('canvas').getContext('webgl'),
                es6: (() => { try { eval('const x = () => {}'); return true; } catch(e) { return false; } })(),
                customEvents: !!window.CustomEvent
            };

            const isCompatible = Object.values(checks).every(check => check);

            if (!isCompatible) {
                document.getElementById('compatibility-warning').style.display = 'block';
                console.warn('Browser compatibility issues detected:', checks);
            }

            return isCompatible;
        }

        // ì„±ëŠ¥ ê°ì§€
        function detectPerformanceLevel() {
            const memory = navigator.deviceMemory || 1;
            const cores = navigator.hardwareConcurrency || 2;

            if (memory <= 1 || cores <= 2) {
                document.body.classList.add('performance-mode-low');
                console.log('Low performance mode enabled');
            }

            return {
                memory: memory,
                cores: cores,
                level: memory <= 1 ? 'low' : memory <= 4 ? 'medium' : 'high'
            };
        }

        class DummyGraphLoader {
            constructor() {
                this.dummyData = JSON.parse(
                    document.getElementById('dummy-graph-data').textContent
                );
            }

            async loadGraph(viewport = null) {
                console.log('Loading dummy graph data...');
                return {
                    nodes: this.dummyData.nodes || [],
                    edges: this.dummyData.edges || []
                };
            }

            cleanup() {}
        }

        // ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”
        async function initializeApp() {
            try {
                // 1. ë¸Œë¼ìš°ì € í˜¸í™˜ì„± ì²´í¬
                const isCompatible = checkBrowserCompatibility();

                // 2. ì„±ëŠ¥ ë ˆë²¨ ê°ì§€
                const performanceInfo = detectPerformanceLevel();
                console.log('Performance info:', performanceInfo);

                // 3. ìº”ë²„ìŠ¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const canvas = document.getElementById('main-canvas');
                if (!canvas) {
                    throw new Error('Canvas element not found');
                }

                // 4. ë”ë¯¸ ë°ì´í„° ë¡œë” ìƒì„±
                const dummyLoader = new DummyGraphLoader();

                // 5. ë©”ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
                console.log('Creating PT Compensation Wiki app...');
                const app = new PTCompensationWiki(canvas, dummyLoader);

                // 6. ë¡œë”© ì™„ë£Œ í›„ ì¦‰ì‹œ í™”ë©´ ì „í™˜
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';

                    // í™˜ì˜ ë©”ì‹œì§€
                    console.log('ğŸ‰ PT Compensation Wiki initialized successfully!');

                    // ì „ì—­ ì ‘ê·¼ì„ ìœ„í•´ windowì— ì €ì¥
                    window.ptWiki = app;

                }, 500); // 2ì´ˆ â†’ 0.5ì´ˆë¡œ ë‹¨ì¶•

            } catch (error) {
                console.error('Failed to initialize application:', error);
                showErrorScreen(error.message);
            }
        }

        // ì˜¤ë¥˜ í™”ë©´ í‘œì‹œ
        function showErrorScreen(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-screen').style.display = 'flex';
        }

        // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing PT Compensation Wiki...');
            initializeApp().catch(error => {
                console.error('Initialization failed:', error);
                showErrorScreen('ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        });

        // ì „ì—­ ì˜¤ë¥˜ ì²˜ë¦¬
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (!window.ptWiki) {
                showErrorScreen('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (!window.ptWiki) {
                showErrorScreen('ë¹„ë™ê¸° ì‘ì—… ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
        if (typeof performance !== 'undefined' && performance.mark) {
            performance.mark('app-start');

            window.addEventListener('load', () => {
                performance.mark('app-loaded');
                performance.measure('app-load-time', 'app-start', 'app-loaded');

                const measure = performance.getEntriesByName('app-load-time')[0];
                console.log(`App load time: ${measure.duration.toFixed(2)}ms`);
            });
        }
    </script>
</body>
</html>