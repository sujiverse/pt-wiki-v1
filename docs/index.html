<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PT 보상작용 위키 - 5Why 그래프 시각화</title>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #main-canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #ffffff;
            cursor: default;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2196f3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 16px;
            color: #666;
            text-align: center;
        }

        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #ffebee;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            color: #c62828;
            text-align: center;
            padding: 40px;
        }

        .error-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .error-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .error-message {
            font-size: 16px;
            margin-bottom: 20px;
            max-width: 600px;
        }

        .retry-button {
            padding: 12px 24px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .retry-button:hover {
            background: #1976d2;
        }

        /* 브라우저 호환성 경고 */
        .compatibility-warning {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #ff9800;
            color: white;
            padding: 10px;
            text-align: center;
            z-index: 10000;
            display: none;
        }

        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .loading-text {
                font-size: 14px;
                padding: 0 20px;
            }

            .error-message {
                font-size: 14px;
            }
        }

        /* 1GB RAM 최적화를 위한 추가 스타일 */
        .performance-mode-low * {
            animation-duration: 0.5s !important;
            transition-duration: 0.2s !important;
        }

        .performance-mode-low .main-button {
            transition: none !important;
        }
    </style>
</head>
<body>
    <!-- 메인 캔버스 -->
    <canvas id="main-canvas"></canvas>

    <!-- 로딩 화면 -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">
            <div>🏥 PT 보상작용 위키 로딩 중...</div>
            <div style="font-size: 12px; margin-top: 10px; color: #999;">
                1GB RAM 최적화 모드로 초기화하고 있습니다
            </div>
        </div>
    </div>

    <!-- 오류 화면 -->
    <div id="error-screen" class="error-screen">
        <div class="error-icon">⚠️</div>
        <div class="error-title">시스템 초기화 실패</div>
        <div class="error-message" id="error-message">
            알 수 없는 오류가 발생했습니다.
        </div>
        <button class="retry-button" onclick="location.reload()">
            🔄 다시 시도
        </button>
    </div>

    <!-- 브라우저 호환성 경고 -->
    <div id="compatibility-warning" class="compatibility-warning">
        ⚠️ 이 브라우저는 일부 기능이 제한될 수 있습니다. Chrome, Firefox, Safari 최신 버전을 권장합니다.
        <button onclick="this.parentElement.style.display='none'" style="margin-left: 10px; background: none; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 3px;">닫기</button>
    </div>

    <!-- 테스트용 더미 데이터 -->
    <script id="dummy-graph-data" type="application/json">
    {
        "nodes": [
            {
                "id": "calf-pain",
                "label": "종아리 통증",
                "type": "symptom",
                "x": 0,
                "y": 0,
                "size": 30,
                "importance": 1.0
            },
            {
                "id": "gastrocnemius-tightness",
                "label": "비복근 긴장",
                "type": "cause",
                "x": 150,
                "y": -50,
                "size": 25,
                "importance": 0.8
            },
            {
                "id": "achilles-shortening",
                "label": "아킬레스건 단축",
                "type": "cause",
                "x": 300,
                "y": -100,
                "size": 25,
                "importance": 0.7
            },
            {
                "id": "ankle-dorsiflexion-limitation",
                "label": "발목 배측굴곡 제한",
                "type": "cause",
                "x": 450,
                "y": -150,
                "size": 25,
                "importance": 0.6
            },
            {
                "id": "prolonged-sitting",
                "label": "장시간 앉기",
                "type": "cause",
                "x": 600,
                "y": -200,
                "size": 20,
                "importance": 0.5
            }
        ],
        "edges": [
            {
                "id": "edge-1",
                "source": "gastrocnemius-tightness",
                "target": "calf-pain",
                "type": "causes",
                "weight": 0.8,
                "label": "근육 긴장이 통증을 유발함"
            },
            {
                "id": "edge-2",
                "source": "achilles-shortening",
                "target": "gastrocnemius-tightness",
                "type": "causes",
                "weight": 0.75,
                "label": "아킬레스건 단축이 비복근 긴장을 유발함"
            },
            {
                "id": "edge-3",
                "source": "ankle-dorsiflexion-limitation",
                "target": "achilles-shortening",
                "type": "causes",
                "weight": 0.7,
                "label": "발목 가동성 제한이 아킬레스건 단축을 유발함"
            },
            {
                "id": "edge-4",
                "source": "prolonged-sitting",
                "target": "ankle-dorsiflexion-limitation",
                "type": "causes",
                "weight": 0.6,
                "label": "장시간 앉기가 발목 가동성을 제한함"
            }
        ]
    }
    </script>

    <!-- 메인 애플리케이션 스크립트 -->
    <script type="module">
        import PTCompensationWiki from './js/main-app.js';

        // 브라우저 호환성 체크
        function checkBrowserCompatibility() {
            const checks = {
                canvas: !!document.createElement('canvas').getContext,
                indexedDB: !!window.indexedDB,
                webGL: !!document.createElement('canvas').getContext('webgl'),
                es6: (() => { try { eval('const x = () => {}'); return true; } catch(e) { return false; } })(),
                customEvents: !!window.CustomEvent
            };

            const isCompatible = Object.values(checks).every(check => check);

            if (!isCompatible) {
                document.getElementById('compatibility-warning').style.display = 'block';
                console.warn('Browser compatibility issues detected:', checks);
            }

            return isCompatible;
        }

        // 성능 감지
        function detectPerformanceLevel() {
            const memory = navigator.deviceMemory || 1;
            const cores = navigator.hardwareConcurrency || 2;

            if (memory <= 1 || cores <= 2) {
                document.body.classList.add('performance-mode-low');
                console.log('Low performance mode enabled');
            }

            return {
                memory: memory,
                cores: cores,
                level: memory <= 1 ? 'low' : memory <= 4 ? 'medium' : 'high'
            };
        }

        class DummyGraphLoader {
            constructor() {
                this.dummyData = JSON.parse(
                    document.getElementById('dummy-graph-data').textContent
                );
            }

            async loadGraph(viewport = null) {
                console.log('Loading dummy graph data...');
                return {
                    nodes: this.dummyData.nodes || [],
                    edges: this.dummyData.edges || []
                };
            }

            cleanup() {}
        }

        // 메인 애플리케이션 초기화
        async function initializeApp() {
            try {
                // 1. 브라우저 호환성 체크
                const isCompatible = checkBrowserCompatibility();

                // 2. 성능 레벨 감지
                const performanceInfo = detectPerformanceLevel();
                console.log('Performance info:', performanceInfo);

                // 3. 캔버스 요소 가져오기
                const canvas = document.getElementById('main-canvas');
                if (!canvas) {
                    throw new Error('Canvas element not found');
                }

                // 4. 더미 데이터 로더 생성
                const dummyLoader = new DummyGraphLoader();

                // 5. 메인 애플리케이션 생성
                console.log('Creating PT Compensation Wiki app...');
                const app = new PTCompensationWiki(canvas, dummyLoader);

                // 6. 로딩 완료 후 즉시 화면 전환
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';

                    // 환영 메시지
                    console.log('🎉 PT Compensation Wiki initialized successfully!');

                    // 전역 접근을 위해 window에 저장
                    window.ptWiki = app;

                }, 500); // 2초 → 0.5초로 단축

            } catch (error) {
                console.error('Failed to initialize application:', error);
                showErrorScreen(error.message);
            }
        }

        // 오류 화면 표시
        function showErrorScreen(message) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-screen').style.display = 'flex';
        }

        // 애플리케이션 시작
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing PT Compensation Wiki...');
            initializeApp().catch(error => {
                console.error('Initialization failed:', error);
                showErrorScreen('애플리케이션 초기화에 실패했습니다: ' + error.message);
            });
        });

        // 전역 오류 처리
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            if (!window.ptWiki) {
                showErrorScreen('시스템 오류가 발생했습니다.');
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            if (!window.ptWiki) {
                showErrorScreen('비동기 작업 오류가 발생했습니다.');
            }
        });

        // 성능 모니터링
        if (typeof performance !== 'undefined' && performance.mark) {
            performance.mark('app-start');

            window.addEventListener('load', () => {
                performance.mark('app-loaded');
                performance.measure('app-load-time', 'app-start', 'app-loaded');

                const measure = performance.getEntriesByName('app-load-time')[0];
                console.log(`App load time: ${measure.duration.toFixed(2)}ms`);
            });
        }
    </script>
</body>
</html>